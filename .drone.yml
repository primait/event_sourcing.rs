---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: git-clone
  image: public.ecr.aws/prima/drone-git:1.3-3
  environment:
    PLUGIN_DEPTH: 5

- name: cache-restore
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - . /etc/profile.d/ecs-credentials-endpoint
  - cache-restore
  environment:
    BUCKET_NAME: prima-ci-cache
    CACHE_COMPRESSION_ALGO: gz
  volumes:
  - name: ecs
    path: /etc/profile.d/ecs-credentials-endpoint
  - name: docker
    path: /var/run/docker.sock
  depends_on:
  - git-clone

- name: check-secrets
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - . /etc/profile.d/ecs-credentials-endpoint
  - check-secrets-grants
  volumes:
  - name: ecs
    path: /etc/profile.d/ecs-credentials-endpoint
  depends_on:
  - git-clone

- name: check-public-docker-images
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - check-public-docker-images
  depends_on:
  - git-clone

- name: build-image
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - sed -i 's/USER app/USER root/g' ./Dockerfile
  - docker build -t prima/event_sourcing.rs-ci:${DRONE_COMMIT} ./
  environment:
    DOCKER_DEFAULT_PLATFORM: linux/amd64
  volumes:
  - name: docker
    path: /var/run/docker.sock
  depends_on:
  - cache-restore

- name: cargo-deps
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo fetch
  environment:
    CARGO_HOME: /drone/src/.cargo
  depends_on:
  - build-image

- name: cargo-format
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo make --profile drone format-ci
  environment:
    CARGO_HOME: /drone/src/.cargo
  depends_on:
  - cargo-deps

- name: cargo-clippy-ci
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo make --profile drone clippy-ci
  environment:
    BUILD_ENV: dev
    CARGO_HOME: /drone/src/.cargo
  depends_on:
  - cargo-format

- name: cargo-test
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo make --profile drone test
  environment:
    BUILD_ENV: dev
    CARGO_HOME: /drone/src/.cargo
  depends_on:
  - cargo-clippy-ci

- name: cargo-build
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo make --profile drone build-ci
  environment:
    BUILD_ENV: dev
    CARGO_HOME: /drone/src/.cargo
  when:
    branch:
      exclude:
      - master
  depends_on:
  - cargo-test

- name: cache-cleanup
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - cargo make --profile drone cache-cleanup
  when:
    branch:
    - master
  depends_on:
  - cargo-build
  - cargo-format
  - cargo-clippy-ci
  - cargo-test

- name: cache-save
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - . /etc/profile.d/ecs-credentials-endpoint
  - cache-save .cargo
  environment:
    BUCKET_NAME: prima-ci-cache
    CACHE_COMPRESSION_ALGO: gz
  volumes:
  - name: ecs
    path: /etc/profile.d/ecs-credentials-endpoint
  - name: docker
    path: /var/run/docker.sock
  when:
    branch:
    - master
  depends_on:
  - cache-cleanup

services:
- name: postgres
  image: public.ecr.aws/bitnami/postgresql:11
  environment:
    POSTGRES_DB: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres

- name: rabbit
  image: public.ecr.aws/bitnami/rabbitmq:3.8
  environment:
    RABBITMQ_PASSWORD: rabbit
    RABBITMQ_USERNAME: rabbit
    RABBITMQ_VHOST: rabbit

- name: zookeeper
  image: public.ecr.aws/prima/zookeeper:7.2.2
  environment:
    ZOOKEEPER_CLIENT_PORT: 2181
    ZOOKEEPER_TICK_TIME: 2000
  ports:
  - 2181

- name: kafka
  image: public.ecr.aws/prima/kafka:7.2.2
  environment:
    JMX_PORT: 9997
    KAFKA_ADVERTISED_LISTENERS: PLAINTEXT_HOST://host.docker.internal:29092, PLAINTEXT://kafka:9092
    KAFKA_BROKER_ID: 1
    KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
    KAFKA_JMX_OPTS: -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=kafka -Dcom.sun.management.jmxremote.rmi.port=9997
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  ports:
  - 9092
  - 9997
  - 29092

volumes:
- name: docker
  host:
    path: /var/run/docker.sock
- name: ecs
  host:
    path: /etc/profile.d/ecs-credentials-endpoint

trigger:
  event:
  - push

---
kind: pipeline
name: build-production

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: git-clone
  image: public.ecr.aws/prima/drone-git:1.3-3
  environment:
    PLUGIN_DEPTH: 5

- name: cache-restore
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - . /etc/profile.d/ecs-credentials-endpoint
  - cache-restore
  environment:
    BUCKET_NAME: prima-ci-cache
    CACHE_COMPRESSION_ALGO: gz
  volumes:
  - name: ecs
    path: /etc/profile.d/ecs-credentials-endpoint
  - name: docker
    path: /var/run/docker.sock
  depends_on:
  - git-clone

- name: build-image
  image: public.ecr.aws/prima/drone-tools:1.22.1
  commands:
  - sed -i 's/USER app/USER root/g' ./Dockerfile
  - docker build -t prima/event_sourcing.rs-ci:${DRONE_COMMIT} ./
  environment:
    DOCKER_DEFAULT_PLATFORM: linux/amd64
  volumes:
  - name: docker
    path: /var/run/docker.sock
  depends_on:
  - cache-restore

- name: build-production
  image: prima/event_sourcing.rs-ci:${DRONE_COMMIT}
  commands:
  - . /etc/profile.d/ecs-credentials-endpoint
  - ./deploy/build production
  environment:
    CARGO_AUTH_KEY:
      from_secret: cargo_auth_key
  volumes:
  - name: ecs
    path: /etc/profile.d/ecs-credentials-endpoint
  depends_on:
  - build-image

volumes:
- name: docker
  host:
    path: /var/run/docker.sock
- name: ecs
  host:
    path: /etc/profile.d/ecs-credentials-endpoint

trigger:
  event:
  - tag
  ref:
  - refs/tags/*.*.*

---
kind: pipeline
name: email-failure

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: email-failure
  image: public.ecr.aws/prima/drone-email
  settings:
    from: drone@prima.it
    host: email-smtp.eu-west-1.amazonaws.com
  environment:
    PLUGIN_PASSWORD:
      from_secret: email_password
    PLUGIN_USERNAME:
      from_secret: email_username

trigger:
  status:
  - failure
  target:
    exclude:
    - qa-stack
    - qa-it
    - qa

depends_on:
- default
- build-production

---
kind: signature
hmac: 54b252cccd203bf13c9c20e7b428b83ca0be143a5036872450e6b0fa12f2ddac

...
